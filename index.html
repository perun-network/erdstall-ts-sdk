<!DOCTYPE html><html class="default"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@polycrypt/erdstall</title><meta name="description" content="Documentation for @polycrypt/erdstall"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.body.classList.add(localStorage.getItem("tsd-theme") || "os")</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@polycrypt/erdstall</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1> @polycrypt/erdstall</h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography">
<a href="#erdstall-typescript-sdk" id="erdstall-typescript-sdk" style="color: inherit; text-decoration: none;">
  <h1>Erdstall TypeScript SDK</h1>
</a>
<p><a href="https://github.com/perun-network/erdstall-ts-sdk/actions/workflows/ci.yml"><img src="https://github.com/perun-network/erdstall-ts-sdk/actions/workflows/ci.yml/badge.svg" alt="CI Status"></a>
<a href="https://perun-network.github.io/erdstall-ts-sdk/"><img src="https://github.com/perun-network/erdstall-ts-sdk/actions/workflows/typedoc.yml/badge.svg" alt="TypeDoc Status"></a>
<a href="https://www.npmjs.com/package/@polycrypt/erdstall"><img src="https://img.shields.io/npm/v/@polycrypt/erdstall" alt="@polycrypt/erdstall at npm"></a>
<a href="https://www.apache.org/licenses/LICENSE-2.0.txt"><img src="https://img.shields.io/badge/license-Apache%202-blue" alt="License: Apache 2.0"></a></p>
<p>This SDK offers the complete client-side interaction with an <a href="https://erdstall.dev/">Erdstall</a> second-layer Ethereum network. It natively integrates with any <a href="https://docs.ethers.io/">ethers.js</a> wallet, such as <a href="https://metamask.io/">Metamask</a> for frontends or <a href="https://docs.ethers.io/v5/api/providers/jsonrpc-provider/">ethers&#39; <code>JsonRpcProvider</code></a> for backends.</p>

<a href="#getting-started" id="getting-started" style="color: inherit; text-decoration: none;">
  <h2>Getting started</h2>
</a>
<p>You can install the Erdstall SDK from <a href="https://www.npmjs.com/package/@polycrypt/erdstall">npm</a> and then setup a client instance like:</p>
<pre><code class="language-ts"><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">ethers</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;ethers&quot;</span><span class="hl-1">;</span><br/><span class="hl-0">import</span><span class="hl-1"> { </span><span class="hl-2">Client</span><span class="hl-1"> } </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;@polycrypt/erdstall&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">ethRpcUrl</span><span class="hl-1"> = </span><span class="hl-3">&quot;ws://127.0.0.1:8545/&quot;</span><span class="hl-1">; </span><span class="hl-6">// local Ganache</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">erdOperatorUrl</span><span class="hl-1"> = </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-7">URL</span><span class="hl-1">(</span><span class="hl-3">&quot;ws://127.0.0.1:8401/ws&quot;</span><span class="hl-1">); </span><span class="hl-6">// local Erdstall Operator</span><br/><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">ethProvider</span><span class="hl-1"> = </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-2">ethers</span><span class="hl-1">.</span><span class="hl-2">providers</span><span class="hl-1">.</span><span class="hl-7">JsonRpcProvider</span><span class="hl-1">(</span><span class="hl-2">ethRpcUrl</span><span class="hl-1">);</span><br/><span class="hl-4">const</span><span class="hl-1"> </span><span class="hl-5">erdClient</span><span class="hl-1"> = </span><span class="hl-4">new</span><span class="hl-1"> </span><span class="hl-7">Client</span><span class="hl-1">(</span><span class="hl-2">ethProvider</span><span class="hl-1">, </span><span class="hl-2">erdOperatorUrl</span><span class="hl-1">);</span><br/><span class="hl-6">// Set up any event listeners needed by the application.</span><br/><span class="hl-6">// client.on(event, handler);</span><br/><span class="hl-6">// Then initialize the client and setup subscriptions.</span><br/><span class="hl-0">await</span><span class="hl-1"> </span><span class="hl-2">erdClient</span><span class="hl-1">.</span><span class="hl-7">initialize</span><span class="hl-1">();</span><br/><span class="hl-0">await</span><span class="hl-1"> </span><span class="hl-2">erdClient</span><span class="hl-1">.</span><span class="hl-7">subscribe</span><span class="hl-1">(); </span><span class="hl-6">// subscribes to all receipts and balance proofs</span><br/><br/><span class="hl-6">// Start your dApp with the Erdstall client</span><br/><span class="hl-2">myDApp</span><span class="hl-1">.</span><span class="hl-7">run</span><span class="hl-1">(</span><span class="hl-2">client</span><span class="hl-1">);</span>
</code></pre>
<p>TypeScript declaration files are shipped with the npm package. Full <a href="https://typedoc.org/">TypeDoc</a>-generated documentation of the source code can be found at <a href="https://perun-network.github.io/erdstall-ts-sdk/">this repository&#39;s Github pages</a>.</p>

<a href="#erdstall-interactions" id="erdstall-interactions" style="color: inherit; text-decoration: none;">
  <h2>Erdstall interactions</h2>
</a>
<p>The SDK&#39;s primary goal is to facilitate interaction with an Erdstall off-chain network as well as the on-chain Erdstall smart contract. The following describes the most important functions of <code>ErdstallClient</code>s (read-only) and <code>ErdstallSession</code>s (also writing).</p>

<a href="#account-queries" id="account-queries" style="color: inherit; text-decoration: none;">
  <h3>Account queries</h3>
</a>
<p>The current balance of any account can be queried using <code>Erdstall.getAccount(who)</code>.</p>

<a href="#entering-and-leaving" id="entering-and-leaving" style="color: inherit; text-decoration: none;">
  <h3>Entering and leaving</h3>
</a>
<p>Fungible Tokens and NFTs can be deposited into the Erdstall network by calling
<code>ErdstallSession.deposit(assets)</code>. This call returns a list of promises of on-chain transactions. Only after all those transactions are mined are the deposits successful. The assets will be available in Erdstall once the blocks containing them have reached the enclave and sufficient finality depth has been reached.</p>
<p>To exit an Erdstall network with all assets, call <code>ErdstallSession.leave()</code>. This will first send an <code>exit</code> request to the Erdstall enclave. Once the epoch has ended, an exit proof will be received from the operator. Due to protocol-security-related reasons, it now has to be waited for another full epoch before an on-chain <code>withdraw</code> transaction can be sent to the Erdstall contract, containing the exit proof that was received in the prior epoch. The call returns a list of transaction promises. Once all those transactions have been mined, the user&#39;s assets will be withdrawn from Erdstall back into their Ethereum wallet.</p>

<a href="#erdstall-transactions" id="erdstall-transactions" style="color: inherit; text-decoration: none;">
  <h3>Erdstall transactions</h3>
</a>
<p>The following transactions are currently possible in any Erdstall network.</p>

<a href="#transfers" id="transfers" style="color: inherit; text-decoration: none;">
  <h4>Transfers</h4>
</a>
<p>To transfer assets within Erdstall, use <code>Erdstall.transferTo(assets, to)</code>.
This transfers the specified assets to the specified recipient, and returns a transaction receipt.</p>

<a href="#trading" id="trading" style="color: inherit; text-decoration: none;">
  <h4>Trading</h4>
</a>
<p>Erdstall natively supports (basket) trading of tokens and NFTs. Currently, simple two-step offer and accept trading is supported. Some external marketplace infrastructure needs to be in place to present trade offers to potential buyers, who can then execute a trade on the Erdstall network.</p>
<p>A trade offer can be created using <code>ErdstallSession.createOffer()</code>. The returned <code>TradeOffer</code> needs the external marketplace infrastructure to reach potential buyers. An interested buyer can then execute the trade by calling <code>ErdstallSession.acceptTrade(offer)</code>, which will send a <code>Trade</code> transaction to the Erdstall network, atomically exchanging the assets between the two accounts.</p>

<a href="#nft-minting-amp-burning" id="nft-minting-amp-burning" style="color: inherit; text-decoration: none;">
  <h4>NFT minting &amp; burning</h4>
</a>
<p><code>ErdstallSession.mint(token, id)</code> can be used to mint a new NFT with on-chain contract address <code>token</code> and id <code>id</code>. The NFT can then be traded freely and is only minted on-chain upon withdrawal.</p>
<p>NFT-owners can burn their tokens with a <code>ErdstallSession.burn(nfts)</code> transaction call. If the NFT was deposited into Erdstall, it will not be burned on-chain, but will indefinitely be locked-up and be held by the NFT-Holder contract.</p>

<a href="#event-subscriptions-amp-callbacks" id="event-subscriptions-amp-callbacks" style="color: inherit; text-decoration: none;">
  <h2>Event Subscriptions &amp; Callbacks</h2>
</a>
<p>After creating an Erdstall client, event handlers can be set up using <code>Erdstall.on()</code> and <code>Erdstall.once()</code>, like</p>
<pre><code class="language-ts"><span class="hl-2">erdClient</span><span class="hl-1">.</span><span class="hl-7">on</span><span class="hl-1">(</span><span class="hl-3">&quot;receipt&quot;</span><span class="hl-1">, (</span><span class="hl-2">rec</span><span class="hl-1">) </span><span class="hl-4">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">console</span><span class="hl-1">.</span><span class="hl-7">log</span><span class="hl-1">(</span><span class="hl-3">`Transaction by </span><span class="hl-4">${</span><span class="hl-2">rec</span><span class="hl-8">.</span><span class="hl-2">tx</span><span class="hl-8">.</span><span class="hl-2">sender</span><span class="hl-4">}</span><span class="hl-3">`</span><span class="hl-1">);</span><br/><span class="hl-1">});</span>
</code></pre>
<p>Handlers set up with <code>on</code> are persistent and are called every time the respective
event is received. <code>once</code>-handlers are only called once and then removed from
the list of handlers. Both type of handlers can also be removed by calling
<code>Erdstall.off()</code>.</p>
<p>Once all event handlers are setup, first <code>await Erdstall.initialize()</code> to initialize the client, then <code>await Erdstall.subscribe()</code> to subscribe to all balance proofs and transaction receipts for all users, or filter to a specific user with address <code>who</code> by calling <code>Erdstall.subscribe(who)</code>. <code>ErdstallSession.subscribeSelf()</code> is a shortcut for subscribing a session to the own user.
Note that handlers can also be added or removed after the client has already been initialized and subscribed.</p>
<details><summary>The following <code>EnclaveEvent</code> events exist (emitted event types are written in parentheses):</summary>

<ul>
<li><p><strong><code>&quot;open&quot;</code></strong> is triggered when the connection to Erdstall is established.
This event is triggered again if the Erdstall connection is lost and automatically re-established.
At startup, you can alternatively use <code>await client.initialize()</code> instead of setting up a handler for this event.</p>
</li>
<li><p><strong><code>&quot;config&quot;(ClientConfig)</code></strong> is triggered when the client configuration is received from the operator after establishing the connections.</p>
</li>
<li><p><strong><code>&quot;close&quot;</code></strong> is triggered when the connection to Erdstall is terminated due to any reason.</p>
</li>
<li><p><strong><code>&quot;error&quot;(string | Error)</code></strong> is triggered when an error occurres within the Erdstall client.</p>
</li>
<li><p><strong><code>&quot;receipt&quot;(TxReceipt)</code></strong> is triggered when a receipt is received from a transaction subscription.
This does not include transaction receipts directly received as a response when issuing transactions.
A transaction receipt contains the transaction itself and the changed balances of all affected parties.</p>
</li>
<li><p><strong><code>&quot;proof&quot;(BalanceProof)</code></strong> is triggered when a balance proof is received from a proof subscription.
These balance proofs are used for exiting the system in case the operator goes offline.</p>
</li>
<li><p><strong><code>&quot;exitproof&quot;(BalanceProof)</code></strong> is triggered when a balance proof, intended for exiting the Erdstall network, is received from a proof subscription.
This happens after a call to <code>Erdstall.exit()</code> or during <code>Erdstall.leave()</code>.</p>
</li>
<li><p><strong><code>&quot;phaseshift&quot;</code></strong> is triggered when a phase shift in the Erdstall network occured, i.e., the last block of an epoch got processed by the enclave.</p>
</details></li>
</ul>
<details><summary>The following <code>LedgerEvent</code> smart contract events exist:</summary>
All on-chain events return a type of the same name as the event, so they are
omitted after each event name in the following.

<ul>
<li><p><strong><code>&quot;Deposited&quot;</code></strong>: an asset got deposited into Erdstall on-chain.</p>
</li>
<li><p><strong><code>&quot;Withdrawn&quot;</code></strong>: assets got withdrawn from Erdstall on-chain.</p>
</li>
<li><p><strong><code>&quot;Frozen&quot;</code></strong>: the operator failed to respond to a challenge within the challenge period. The Erdstall system is now frozen forever, and funds must be withdrawn using the latest <em>sealed</em> balance proof.</p>
</li>
<li><p><strong><code>&quot;Challenged&quot;</code></strong>: someone challenged the Erdstall operator, who must now respond with the challenged balance proof.</p>
</li>
<li><p><strong><code>&quot;ChallengeResponded&quot;</code></strong>: the Erdstall operator successfully responed with the correct balance proof.</p>
</li>
<li><p><strong><code>&quot;TokenTypeRegistered&quot;</code></strong>: a new token type (such as ETH, ERC20, ERC721, etc.) has been registered with Erdstall on-chain.</p>
</li>
<li><p><strong><code>&quot;TokenRegistered&quot;</code></strong>: a specific token contract has been registered on-chain.</p>
</details></li>
</ul>

<a href="#development" id="development" style="color: inherit; text-decoration: none;">
  <h2>Development</h2>
</a>

<a href="#typedjson" id="typedjson" style="color: inherit; text-decoration: none;">
  <h3>TypedJSON</h3>
</a>
<p>The Erdstall SDK internally uses <a href="https://github.com/JohnWeisz/TypedJSON"><code>TypedJSON</code></a> to define class JSON serialization.
If you want to use TypedJSON in your project for class serialization, possibly using some Erdstall classes as field types, you <em>must</em> use the re-exported module <code>typedjson</code> from <code>@polycrypt/erdstall/export/typedjson</code> like</p>
<pre><code class="language-ts"><span class="hl-0">import</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-2">jsonObject</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">jsonMember</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-2">TypedJSON</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-0">from</span><span class="hl-1"> </span><span class="hl-3">&quot;@polycrypt/erdstall/export/typedjson&quot;</span><span class="hl-1">;</span>
</code></pre>
<p>The reason is that TypedJSON internally registers class serializations in static members of the <code>TypedJSON</code> class.
If you use your own version of <code>typedjson</code> from your <code>node_modules</code>, these modules will not share state and serialization will not work.</p>

<a href="#bigint-members" id="bigint-members" style="color: inherit; text-decoration: none;">
  <h4><code>bigint</code> members</h4>
</a>
<p>If you use TypedJSON to serialize your own classes and they have a field of type <code>bigint</code>, it is best to use the annotation <code>@jsonBigIntMember()</code> from <code>@polycrypt/erdstall/export/typedjson</code>, which defines a base-10 string serialization format.</p>

<a href="#contract-bindings" id="contract-bindings" style="color: inherit; text-decoration: none;">
  <h3>Contract bindings</h3>
</a>
<p>Contract bindings can be generated from the <a href="https://github.com/perun-network/erdstall-contracts"><code>erdstall-contracts</code></a> repository.
Just clone it into a directory of your choice and execute <code>yarn bindings &lt;path/to/erdstall-contracts&gt;</code>.
<strong>Note</strong>: Do not forget to install the dependencies in <code>erdstall-contracts</code> with <code>yarn</code>.</p>

<a href="#background" id="background" style="color: inherit; text-decoration: none;">
  <h2>Background</h2>
</a>

<a href="#erdstall" id="erdstall" style="color: inherit; text-decoration: none;">
  <h3>Erdstall</h3>
</a>
<p><a href="https://erdstall.dev">Erdstall</a> is a layer-2 platform for Ethereum developed by <a href="https://polycry.pt">PolyCrypt</a> based on research (<a href="https://eprint.iacr.org/2020/1486">:page_facing_up: CommiTEE</a>) by the chair of applied cryptography at the technical university of Darmstadt, Germany.</p>
<p>It uses a <a href="https://en.wikipedia.org/wiki/Trusted_Platform_Module">TPM</a> — such as Intel SGX or ARM TrustZone — ensuring reliable and trustworthy execution of the platform without the need for public verification of all computations (in comparison to accumulated zero-knowledge proofs, TPMs allow the generation of more compact and less computationally expensive proofs, thereby scaling much better and consuming less power).
In Erdstall, the TEE operator periodically generates checkpoints, also called balance proofs, that can be used to exit the system if the operator were to go offline.</p>

<a href="#benefits-of-erdstall" id="benefits-of-erdstall" style="color: inherit; text-decoration: none;">
  <h3>Benefits of Erdstall</h3>
</a>
<p>In addition to scaling payments as a layer-2 platform, Erdstall also specifically aims to be the secure asset management layer for non-custodial off-chain marketplaces.</p>
<p>A marketplace built on top of Erdstall does not have to manage any funds on its own, it only has to match the trading parties, while it can earn a flat fee per facilitated trade.
This makes the marketplace more trustworthy, as a cyber-attack on the marketplace cannot result in lost funds.
As a result, Erdstall allows users to enjoy the security, control, and trust of non-custodial trading, combined with the low cost of off-chain transacting.
Meanwhile, market operators benefit from fast throughput and low operation costs, innate user-trust, and fast and cheap deposits and withdrawals via Erdstall.
Another benefit is that content creators can natively mint NFTs off-chain, and the cost of on-chain token creation only happens when the NFT is withdrawn by a user into the Ethereum mainnet.
Because our protocol is very light-weight, it is easy to integrate into existing solutions.</p>

<a href="#license" id="license" style="color: inherit; text-decoration: none;">
  <h2>License</h2>
</a>
<p>This work is released under the Apache 2.0 license. See LICENSE file for more
details.</p>
<p><em>Copyright (C) 2021 - The Erdstall Authors.</em></p>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Modules</a></li><li class=" tsd-kind-module"><a href="modules/api.html">api</a></li><li class=" tsd-kind-module"><a href="modules/enclave.html">enclave</a></li><li class=" tsd-kind-module"><a href="modules/index.html">index</a></li><li class=" tsd-kind-module"><a href="modules/ledger.html">ledger</a></li><li class=" tsd-kind-module"><a href="modules/ledger_backend.html">ledger/backend</a></li><li class=" tsd-kind-module"><a href="modules/test.html">test</a></li><li class=" tsd-kind-module"><a href="modules/utils.html">utils</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-namespace"><span class="tsd-kind-icon">Namespace</span></li><li class="tsd-kind-variable"><span class="tsd-kind-icon">Variable</span></li><li class="tsd-kind-function"><span class="tsd-kind-icon">Function</span></li><li class="tsd-kind-function tsd-has-type-parameter"><span class="tsd-kind-icon">Function with type parameter</span></li><li class="tsd-kind-type-alias"><span class="tsd-kind-icon">Type alias</span></li><li class="tsd-kind-type-alias tsd-has-type-parameter"><span class="tsd-kind-icon">Type alias with type parameter</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-class"><span class="tsd-kind-icon">Class</span></li><li class="tsd-kind-class tsd-has-type-parameter"><span class="tsd-kind-icon">Class with type parameter</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-interface"><span class="tsd-kind-icon">Interface</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>